# Environment Setup Guide

This guide will help you set up the development environment and manage secrets for all deployment stages.

## Prerequisites

- Node.js 18+ and pnpm 9+
- AWS CLI configured (for deployment)
- Neon PostgreSQL database (for all environments)

## Local Development Setup

### 1. Clone and Install Dependencies

```bash
# Clone the repository
git clone <your-repo-url>
cd blog

# Install dependencies
pnpm install
```

### 2. Environment Configuration

```bash
# Copy environment template
cp .env.example .env.local

# Edit the environment file
nano .env.local  # or your preferred editor
```

### 3. Required Environment Variables

Update `.env.local` with your actual values:

```bash
# Database - Get from Neon dashboard
DATABASE_URL="postgresql://username:password@hostname:5432/database_name?sslmode=require"

# Generate secrets
NEXTAUTH_SECRET="$(openssl rand -base64 32)"
PAYLOAD_SECRET="$(openssl rand -base64 32)"

# Local development URLs
NEXTAUTH_URL="http://localhost:3002"
PAYLOAD_PUBLIC_SERVER_URL="http://localhost:3000"
NEXT_PUBLIC_API_URL="http://localhost:3000"
```

### 4. Database Setup

```bash
# Run CMS migrations
pnpm cms:migrate

# Generate TypeScript types
pnpm cms:types
```

### 5. Start Development

```bash
# Start all applications
pnpm dev

# Or start individually
pnpm dev:landing   # Astro on :4321
pnpm dev:blog      # Next.js on :3002  
pnpm dev:cms       # PayloadCMS on :3000
pnpm dev:backend   # Express API on :3001
```

## SST Secrets Management

SST uses encrypted secrets for sensitive data across environments. Set them up using the SST CLI:

### Development Environment

```bash
# Set development secrets
pnpm sst secret set DatabaseUrl "postgresql://dev-username:password@hostname/dev-database" --stage development
pnpm sst secret set NextAuthSecret "$(openssl rand -base64 32)" --stage development
pnpm sst secret set PayloadSecret "$(openssl rand -base64 32)" --stage development
```

### Staging Environment

```bash
# Set staging secrets
pnpm sst secret set DatabaseUrl "postgresql://staging-username:password@hostname/staging-database" --stage staging
pnpm sst secret set NextAuthSecret "$(openssl rand -base64 32)" --stage staging
pnpm sst secret set PayloadSecret "$(openssl rand -base64 32)" --stage staging
```

### Production Environment

```bash
# Set production secrets
pnpm sst secret set DatabaseUrl "postgresql://prod-username:password@hostname/prod-database" --stage production
pnpm sst secret set NextAuthSecret "$(openssl rand -base64 32)" --stage production
pnpm sst secret set PayloadSecret "$(openssl rand -base64 32)" --stage production
```

### Managing Secrets

```bash
# List all secrets for a stage
pnpm sst secret list --stage development

# Update a secret
pnpm sst secret set DatabaseUrl "new-database-url" --stage development

# Remove a secret
pnpm sst secret remove SecretName --stage development
```

## GitHub Actions Setup

### Required Repository Secrets

Add these secrets to your GitHub repository settings:

```bash
# AWS Credentials for deployment
AWS_ACCESS_KEY_ID="your-aws-access-key"
AWS_SECRET_ACCESS_KEY="your-aws-secret-key"
```

### Optional: Environment-Specific Secrets

If you prefer to manage secrets via GitHub instead of SST:

```bash
# Development
DEV_DATABASE_URL="postgresql://..."
DEV_NEXTAUTH_SECRET="..."
DEV_PAYLOAD_SECRET="..."

# Staging  
STAGING_DATABASE_URL="postgresql://..."
STAGING_NEXTAUTH_SECRET="..."
STAGING_PAYLOAD_SECRET="..."

# Production
PROD_DATABASE_URL="postgresql://..."
PROD_NEXTAUTH_SECRET="..."
PROD_PAYLOAD_SECRET="..."
```

## Deployment Commands

### Local Development with SST

```bash
# Start SST development mode (creates AWS resources)
pnpm sst:dev

# Deploy to development environment
pnpm sst:deploy:development

# Deploy to staging
pnpm sst:deploy:staging

# Deploy to production (manual approval required)
pnpm sst:deploy:production
```

### Environment Cleanup

```bash
# Remove development environment
pnpm sst:remove:development

# Remove staging environment  
pnpm sst:remove:staging

# Remove old "jaredconnor" environment
pnpm sst:remove:jaredconnor
```

## Environment URLs

### Development
- Development URLs are auto-generated by SST
- Check SST console output for URLs

### Staging
- Landing: https://staging.jaredconnor.dev
- Blog: https://blog-staging.jaredconnor.dev
- CMS: https://cms-staging.jaredconnor.dev

### Production
- Landing: https://jaredconnor.dev
- Blog: https://blog.jaredconnor.dev
- CMS: https://cms.jaredconnor.dev

## Troubleshooting

### Common Issues

1. **Database Connection Issues**
   - Verify DATABASE_URL format includes `?sslmode=require`
   - Check Neon database status and connection limits

2. **SST Deployment Failures**
   - Verify AWS credentials are configured
   - Check CloudFormation stack events in AWS Console
   - Ensure secrets are set for the target stage

3. **Build Failures**
   - Run `pnpm clean && pnpm install` to reset dependencies
   - Check TypeScript errors with `pnpm check-types`
   - Verify environment variables are set correctly

### Getting Help

- Check SST Console: `pnpm sst:console`
- View AWS CloudFormation stacks for deployment status
- Check GitHub Actions logs for CI/CD issues

## Security Best Practices

1. **Never commit secrets** - Use `.env.local` for local development
2. **Use SST secrets** for deployment environments
3. **Rotate secrets regularly** - especially for production
4. **Use least-privilege IAM roles** for AWS access
5. **Enable MFA** on AWS accounts with deployment access